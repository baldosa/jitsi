---
- name: Add stretch repository
  become: yes
  apt_repository:
    repo: deb http://deb.debian.org/debian stretch main
    state: present
    filename: 'local-stretch'
  when: ansible_distribution != 'Ubuntu'

- name: Add bionic repository
  become: yes
  apt_repository:
    repo: deb http://security.ubuntu.com/ubuntu bionic-security main
    state: present
    filename: 'local-bionic'
  when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '20.04'

- name: Install packages for luacrypto
  become: yes
  apt:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - libssl1.0-dev
      - gcc
      - git
      - lua-cjson-dev
      - liblua5.2-dev
      - luarocks

- name: Install libssl1.0-dev
  become: yes
  apt:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - libssl1.0.2
  when: ansible_distribution != 'Ubuntu'

- name: Build lua luajwtjitsi
  become: yes
  command:
    cmd: luarocks install luajwtjitsi
    creates: /usr/local/lib/luarocks/rocks/luajwtjitsi
  notify:
    - restart prosody

- name: Remove locally created lua-cjson, breaks prosody
  become: yes
  file:
    path: /usr/local/lib/lua/5.2/cjson.so
    state: absent

- name: Remove stretch repository
  become: yes
  apt_repository:
    repo: deb http://deb.debian.org/debian stretch main
    state: absent
    filename: 'local-stretch'
  when: ansible_distribution != 'Ubuntu'

- name: Remove bionic repository
  become: yes
  apt_repository:
    repo: deb http://security.ubuntu.com/ubuntu bionic-security main
    state: absent
    filename: 'local-bionic'
  when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '20.04'

- name: Restore libssl-dev
  become: yes
  apt:
    name: libssl-dev
    state: present
